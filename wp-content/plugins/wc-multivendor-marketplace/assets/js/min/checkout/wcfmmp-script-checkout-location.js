jQuery(document).ready(function(e){var o=geocoder=marker=map_marker=infowindow="";function t(o,t,a,n){n&&("google"==wcfm_maps.lib?document.getElementById("wcfmmp_user_location").value=o:(e("#wcfmmp_user_location").val(o),e("#leaflet_wcfmmp_user_location").find(".search-input").val(o))),document.getElementById("wcfmmp_user_location_lat").value=t,document.getElementById("wcfmmp_user_location_lng").value=a,e(document.body).trigger("update_checkout")}function a(e,t,a){google.maps.event.addListener(t,"click",function(){e.setContent(a),e.open(o,t)})}$wcfmmp_user_location_lat=jQuery("#wcfmmp_user_location_lat").val(),$wcfmmp_user_location_lng=jQuery("#wcfmmp_user_location_lng").val(),jQuery("#wcfmmp_user_location_lat").length>0&&setTimeout(function(){!function(){if("google"==wcfm_maps.lib){var n=new google.maps.LatLng(wcfmmp_checkout_map_options.default_lat,wcfmmp_checkout_map_options.default_lng,13);o=new google.maps.Map(document.getElementById("wcfmmp-user-locaton-map"),{center:n,mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:parseInt(wcfmmp_checkout_map_options.default_zoom)});var r={url:wcfmmp_checkout_map_options.store_icon,scaledSize:new google.maps.Size(wcfmmp_checkout_map_options.icon_width,wcfmmp_checkout_map_options.icon_height)};marker=new google.maps.Marker({map:o,position:n,animation:google.maps.Animation.DROP,icon:r,draggable:!0});var m=document.getElementById("wcfmmp_user_location");geocoder=new google.maps.Geocoder;var i=new google.maps.places.Autocomplete(m);i.bindTo("bounds",o),infowindow=new google.maps.InfoWindow,i.addListener("place_changed",function(){infowindow.close(),marker.setVisible(!1);var e=i.getPlace();e.geometry?(e.geometry.viewport?o.fitBounds(e.geometry.viewport):(o.setCenter(e.geometry.location),o.setZoom(parseInt(wcfmmp_checkout_map_options.default_zoom))),marker.setPosition(e.geometry.location),marker.setVisible(!0),t(e.formatted_address,e.geometry.location.lat(),e.geometry.location.lng(),!1),infowindow.setContent(e.formatted_address),infowindow.open(o,marker),a(infowindow,marker,e.formatted_address)):window.alert("Autocomplete returned place contains no geometry")}),google.maps.event.addListener(marker,"dragend",function(){geocoder.geocode({latLng:marker.getPosition()},function(e,n){n==google.maps.GeocoderStatus.OK&&e[0]&&(t(e[0].formatted_address,marker.getPosition().lat(),marker.getPosition().lng(),!0),infowindow.setContent(e[0].formatted_address),infowindow.open(o,marker),a(infowindow,marker,e[0].formatted_address))})})}else{e("#wcfmmp_user_location").replaceWith('<div id="leaflet_wcfmmp_user_location"></div><input type="hidden" class="wcfm_custom_hide" name="wcfmmp_user_location" id="wcfmmp_user_location" />'),$wcfmmp_user_location_lat&&$wcfmmp_user_location_lng?((o=new L.Map("wcfmmp-user-locaton-map",{zoom:parseInt(wcfmmp_checkout_map_options.default_zoom),center:new L.latLng([$wcfmmp_user_location_lat,$wcfmmp_user_location_lng])})).addLayer(new L.TileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")),map_marker=L.marker([$wcfmmp_user_location_lat,$wcfmmp_user_location_lng],{draggable:"true"}).addTo(o).on("click",function(){window.open("https://www.openstreetmap.org/?mlat="+$wcfmmp_user_location_lat+"&mlon="+$wcfmmp_user_location_lng+"#map=14/"+$wcfmmp_user_location_lat+"/"+$wcfmmp_user_location_lng,"_blank")})):((o=new L.Map("wcfmmp-user-locaton-map",{zoom:parseInt(wcfmmp_checkout_map_options.default_zoom),center:new L.latLng([wcfmmp_checkout_map_options.default_lat,wcfmmp_checkout_map_options.default_lng])})).addLayer(new L.TileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")),map_marker=L.marker([0,0],{draggable:"true"})),map_marker.on("dragend",function(o){var a=map_marker.getLatLng(),n="http://nominatim.openstreetmap.org/reverse?format=json&lat="+a.lat+"&lon="+a.lng+"&zoom=18&addressdetails=1",r="";e.getJSON(n).done(function(e){e.address.road?r+=e.address.road+", ":e.address.pedestrian?r+=e.address.pedestrian+", ":r="",e.address.house_number&&(r+=e.address.house_number+", "),e.address.city_district&&(r+=e.address.city_district+", "),e.address.city&&(r+=e.address.city+", "),e.address.postcode&&(r+=e.address.postcode),t(r,a.lat,a.lng,!0);var o=r;map_marker.bindPopup(o).openPopup()})});var c=new L.Control.Search({container:"leaflet_wcfmmp_user_location",url:"https://nominatim.openstreetmap.org/search?format=json&q={s}",jsonpParam:"json_callback",propertyName:"display_name",propertyLoc:["lat","lon"],marker:map_marker,moveToLocation:function(e,o,a){t(o,e.lat,e.lng,!0),a.setView(e,parseInt(wcfmmp_checkout_map_options.default_zoom))},initial:!1,collapsed:!1,autoType:!1,minLength:2});o.addControl(c),setTimeout(function(){o.invalidateSize()},3e3)}}(),navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(n){$current_location_fetched=!0,console.log(n.coords.latitude,n.coords.longitude),"google"==wcfm_maps.lib?geocoder.geocode({location:{lat:n.coords.latitude,lng:n.coords.longitude}},function(e,r){if("OK"===r){t(e[0].formatted_address,n.coords.latitude,n.coords.longitude,!0);var m=new google.maps.LatLng(n.coords.latitude,n.coords.longitude);marker.setPosition(m),marker.setVisible(!0),infowindow.setContent(e[0].formatted_address),infowindow.open(o,marker),a(infowindow,marker,e[0].formatted_address)}}):e.get("https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat="+n.coords.latitude+"&lon="+n.coords.longitude,function(e){t(e.address.road,n.coords.latitude,n.coords.longitude,!0),map_marker.bindPopup(e.address.road).openPopup()})})},1e3)});